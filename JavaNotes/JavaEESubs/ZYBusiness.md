# Business Notes

## SKU & SPU

- SKU：Stock Keeping Unit：库存量单位
  - 一个SPU所有可选择属性的排列组合的其中一个即为SKU，衡量库存的单位
- SPU：Standard Product Unit：标准产品单位
  - 一个Product



## 下单减库存还是支付减库存

### 下单减库存

下单减库存是指当买家拍下商品后，商品商品显示的库存数量就会相应减少。建议商品库存数量较为敏感中使用。

#### 优点

买家体验较好

#### 缺点

- 恶拍：有可能有恶意下单不支付导致正常用户不能购买

### 支付减库存

付款减库存是指当买家下单并支付后，卖家商品显示的库存数量才会相应减少。建议在商品库存数量不敏感的业务中使用。

#### 优点

防止恶意下单

#### 缺点

用户体验不佳，犹豫之后支付告知没货了

### 总结

无论是哪种减库存方式，其最终目的都是一致的：对于商家来说，保障每个商品都能卖出去；对于买家来说，每个人都能尽可能的买到想要的商品。这就需要在商家与买家之间进行权衡。

## 订单生成、库存扣减与支付逻辑

### 一、扣减库存的三种方案

（1）下单减库存

　　用户下单时减库存

　　优点：实时减库存，避免付款时因库存不足减库存的问题

　　缺点：恶意买家大量下单，将库存用完，但是不付款，真正想买的人买不到

（2）付款减库存

　　下单页面显示最新的库存，下单时不会立即减库存，而是等到支付时才会减库存。

　　优点：防止恶意买家大量下单用光库存，避免下单减库存的缺点

　　缺点：下单页面显示的库存数可能不是最新的库存数，而库存数用完后，下单页面的库存数没有刷新，出现下单数超过库存数，若支付的订单数超过库存数，则会出现支付失败。

（3）预扣库存
　　下单页面显示最新的库存，下单后保留这个库存一段时间（比如10分钟），超过保留时间后，库存释放。若保留时间过后再支付，如果没有库存，则支付失败。例如：要求30分钟内支付订单。

　　优点：结合下单减库存的优点，实时减库存，且缓解恶意买家大量下单的问题，保留时间内未支付，则释放库存。

　　缺点：保留时间内，恶意买家大量下单将库存用完。并发量很高的时候，依然会出现下单数超过库存数。

### 二、如何解决恶意买家下单的问题

这里的恶意买家指短时间内大量下单，将库存用完的买家。

（1）限制用户下单数量
　　优点：限制恶意买家下单

　　缺点：用户想要多买几件，被限制了，会降低销售量

（2）标识恶意买家
　　优点：卖家设定一个备用库存，当支付时，库存已用完，扣减备用库存数，这就是常见的补货场景

　　缺点：因高并发场景下，数据可能存在不一致性的问题

### 三、如何解决下单成功而支付失败（库存不足）的问题

（1）备用库存
　　商品库存用完后，如果还有用户支付，直接扣减备用库存。

　　优点：缓解部分用户支付失败的问题

　　缺点：备用库存只能缓解问题，不能从根本上解决问题。另外备用库存针对普通商品可以，针对特殊商品这种库存少的，备用库存量也不会很大，还是会出现大量用户下单成功却因库存不足而支付失败的问题。

### 四、如何解决高并发下库存超卖的场景

库存超卖最简单的解释就是多成交了订单而发不了货。

场景：

用户A和B成功下单，在支付时扣减库存，当前库存数为10。因A和B查询库存时，都还有库存数，所以A和B都可以付款。

A和B同时支付，A和B支付完成后，可以看做两个请求回调后台系统扣减库存，有两个线程处理请求，两个线程查询出来的库存数 inventory=10，

然后A线程更新最终库存数 lastInventory=inventory - 1 = 9，

B线程更新库存数 lastInventory=inventory - 1 = 9。

而实际最终的库存应是8才对，这样就出现库存超卖的情况，而发不出货。

那如何解决库存超卖的情况呢？

1.SQL语句更新库存时，如果扣减库存后，库存数为负数，直接抛异常，利用事务的原子性进行自动回滚。

2.利用SQL语句更新库存，防止库存为负数

```
 UPDATE [库存表] SET 库存数 - 1 WHERE 库存数 - 1 > 0



 



 如果影响条数大于1，则表示扣减库存成功，否则订单失败，并退款。
```

###  五、秒杀场景下如何扣减库存

（1）下单减库存
因秒杀场景下，大部分用户都是想直接购买商品的，可以直接用下单减库存。

大量用户和恶意用户都是同时进行的，区别是正常用户会直接购买商品，恶意用户虽然在竞争抢购的名额，但是获取到的资格和普通用户一样，所以下单减库存在秒杀场景下，恶意用户下单并不能造成之前说的缺点。

而且下单直接扣减库存，这个方案更简单，在第一步就扣减库存了。

（2）将库存放到redis缓存中
　　查询缓存要比查询数据库快，所以将库存数放在缓存中，直接在缓存中扣减库存。然后在通过MQ异步完成数据库处理。

（3）使用量自增方式
可以先增加已使用量，然后与设定的库存进行比较，如果超出，则将使用量减回去。

项目中用到了很多机制，但是没有总结出来，学习架构需要不断地总结。

### 六 第三方支付

1 支付成功多次回调：把减库存放在[微信支付](https://www.baidu.com/s?wd=微信支付&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd)的成功回调URL的方法里面。但是微信支付成功之后微信支付平台会发送8次请求到回调地址。这样的做法就会导致库存减少，一定要验证返回的编号是否已经完成扣减。



# Business Combing

## 远程问诊

### 业务

远程问诊主要利用远程视频的方式来解决基层诊室对于自身无法解决疾病的问题，实现方案有两套，一套是使用小鱼硬件实现，另一套是使用腾讯实时音视频服务实现。

### 技术

该项目主要 使用Dubbo技术栈实现

服务高可用以及负载均衡使用LVS+keepalived+Nginx实现，服务的治理和发现使用Dubbo+ZooKeeper实现，服务之间的调用使用Dubbo实现，服务的

问题：关于服务的发现的各种组件中，都是采用那些方式进行服务的发现的？是推消息还是拉消息

## 致医云屏

### 业务

致医云屏是一个主要为基层诊所提供**排号服务**，**叫号服务**和**广告服务**的一款软硬结合的产品。

**排号服务**是就诊医生给待就诊患者挂号的服务；**叫号服务**是坐诊医生通过致医云诊室硬件或者电脑软件进行叫号，由服务器下发指令到搭载安卓操作系统的云屏硬件和即将到号的用户微信服务号。**广告服务**是用来解决诊室广告杂乱张贴的问题，属于致医云诊室的周边产品。该产品前端包括搭载安卓操作系统的硬件，后端包括前端服务系统和BOSS系统；[广告系统设计](http://www.woshipm.com/pd/959828.html)

云屏业务目前已覆盖全国18w余家基层诊所；

18 0000 * 1.2 = 21 6000台 // 平均每家诊所1.2台云屏

平常：

21 6000 * 0.4 = 8 6400台 // 活跃云屏40%，共计86400台

活动：

21 6000 * 0.9 = 19 4400台 // 活跃云屏90%，共计194400台



由于后期会大力推广，所以服务压力会比较大，所以允许使用一些比较新的技术
在我的能力范围内，推进两个项目，云屏和问诊，由于云屏的压力相对会比问诊的压力大，所以这两个项目的框架需要有层级，即云屏的技术相比于问诊要更加沉稳一点，经过仔细斟酌与讨论，云屏使用了Dubbo的技术栈，问诊使用SpringCloudAlibaba

